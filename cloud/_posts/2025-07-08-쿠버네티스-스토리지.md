---
layout: post
title: 쿠버네티스 컨테이너 스토리지
tags: kubernetses
image: ''
---

## 쿠버네티스 컨테이너에서 스토리지란?

쿠버네티스에서 파드(Pod) 속 컨테이너의 생애 주기는 매우 유동이다 컨테이너에 문제가 생겨 충돌이 발생하면 쿠버네티스는 해당 컨테이너를 종료하고 새로운 컨테이너를 시작하여 파드를 복구하는데 이때 가장 큰 문제는 **데이터의 휘발성** 즉, 데이터가 사라진다

파드가 재시작되거나, 다른 노드로 교체(스케줄링)되면 데이터는 보존되지 않고 초기 상태로 돌아간다 애플리케이션의 중요한 데이터를 잃지 않으려면, 파드의 생애 주기와 독립적으로 데이터를 저장할 수 있는 볼륨(Volume)이 필요하다

&nbsp;

## emptyDir: 파드와 생애 주기를 함께하는 임시 볼륨

`emptyDir` 볼륨은 파드가 생성될 때 만들어지는 임시 디렉터리 이름처럼 처음에는 비어있는 상태로 시작

- **특징**: 파드와 동일한 생애 주기를 갖는다
- **장점**: 파드 내의 여러 컨테이너가 동일한 `emptyDir` 볼륨을 마운트하여 파일을 공유할 수 있다 컨테이너가 재시작되더라도 파드가 살아있는 동안에는 데이터가 유지
- **단점**: 파드가 삭제되거나 다른 노드로 재스케줄링되면 `emptyDir`의 모든 데이터는 영구적으로 사라진다

<center><img src="https://image.minnnningnas.duckdns.org/images/1739ed92-f1e3-4027-beeb-8285c84a3e7e.webp" style="zoom:20%;"></center>

&nbsp;

### 실습: 데이터 유지 및 소멸 과정 확인

#### 1. emptyDir를 사용하는 파드 생성

아래 YAML 파일을 `emptydir-pod.yaml`로 저장 이 파드는 `emptyDir` 볼륨(`cache-volume`)을 생성하고, 컨테이너의 `/cache` 경로에 마운트한다

``` yaml
# emptydir-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-emptydir
spec:
  containers:
  - name: container-1
    image: kiamol/ch03-sleep
    volumeMounts:
    - name: cache-volume
      mountPath: /cache
  volumes:
  - name: cache-volume
    emptyDir: {}

```

``` bash
kubectl apply -f emptydir-pod.yaml #배포
```

#### 2. 볼륨에 파일 생성 및 컨테이너 강제 종료

파드 내부로 들어가 마운트된 경로에 파일을 생성

```bash
# 파드 내부 셸로 접속
kubectl exec -it test-emptydir -- /bin/sh

# /cache 디렉터리로 이동하여 파일 생성
cd /cache
echo "Hello from container 1" > test.txt
cat test.txt
Hello from container 1

# 셸 종료
exit
```

이제 컨테이너를 강제로 종료하여 쿠버네티스가 컨테이너를 재시작하도록 유도

```bash
kubectl exec -it test-emptydir -- /bin/kill 1
```

<center><img src="https://image.minnnningnas.duckdns.org/images/a681cfa7-23b7-4373-81bd-cbb97f7c73f2.webp" style="zoom:50%;"></center>

위 과정으로 보면 컨테이너를 삭제해도 해당 텍스트 문서는 유지되었다

#### 3. 파드 삭제 후 데이터 소멸 확인

이제 파드를 삭제하고 다시 생성

```bash
kubectl delete pod test-emptydir
kubectl apply -f emptydir-pod.yaml
```

새로 생성된 파드에 접속하여 `/cache` 디렉터리를 확인하면, 이전에 만들었던 `test.txt` 파일이 사라지고 다시 비어있는 디렉터리가 된 것을 볼 수 있다

```bash
kubectl exec -it test-emptydir -- /bin/sh

cd cache
ls
# 비어있음
```

이처럼 `emptyDir`는 파드의 생애 주기에 완전히 종속된다

&nbsp;

## hostPath: 노드에 데이터를 고정하는 볼륨

파드가 사라져도 데이터를 보존하기 위한 가장 간단한 방법은 파드가 실행 중인 **노드(Node)의 파일 시스템**에 데이터를 직접 저장 이를 `hostPath` 볼륨이라고 한다

- **특징**: 노드의 특정 디렉터리를 컨테이너에 마운트

- **장점**: 파드가 삭제되고 동일한 노드에 다시 생성되어도 데이터가 유지

- **단점**:
  - **노드 종속성**: 파드가 다른 노드에 생성되면 해당 데이터에 접근할 수 없다 이는 2개 이상의 노드를 사용하는 클러스터에서 심각한 문제를 일으킬 수 있음
  - **보안 취약점**: 컨테이너가 노드의 파일 시스템에 직접 접근할 수 있게 되므로, 악의적인 컨테이너가 호스트 시스템을 공격하는 통로가 될 수 있음

<center><img src="https://image.minnnningnas.duckdns.org/images/10c6336b-8a46-4f91-b6a9-1b0fdd68b22a.webp" style="zoom:20%;"></center>

